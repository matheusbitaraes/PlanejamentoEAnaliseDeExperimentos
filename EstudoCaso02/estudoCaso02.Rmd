---
title: "Estudo de Caso 02: Avaliação e comparação do retorno médio de ações"
author: "Diego Pontes, Elias Vieira, Matheus Bitarães"
date: "Fevereiro, 2021"
output:
    pdf_document:
    fig_caption: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include=FALSE}

# Importação das bibliotecas (descomentar caso não tenha instalado)

# install.packages("ggplot2"))
# install.packages("gridExtra")
# install.packages("agricolae")

# Importação de bibliotecas
library(ggplot2)
library(gridExtra)
library(dplyr)
library(car)

```

## Descrição do problema

Neste estudo, deseja-se comparar a rentabilidade de cinco ações diferentes no decorrer dos últimos 36 meses a fim de encontrar aquela com maior rentabilidade para que determinado investidor possa aplicar todo montante financeiro com um maior rendimento para o próximo mês.

## Introdução

Nos últimos anos, o mercado financeiro no Brasil tem ganhado bastante destaque. Devido a queda na taxa básica de juros, que está em sua mínima histórica e, consequentemente, a redução nos rendimentos dos investimentos em renda fixa, os investidores estão migrando cada vez mais da renda fixa para a renda variável buscando um maior retorno em seus investimentos.

Esse cenário tem impulsionado o setor financeiro de uma forma como nunca tinha sido vista no país. Com isso, corretoras, casas de análises, agentes de investimentos e outros serviços têm sido cada vez mais procurados e solicitados pelos novos investidores que desejam entrar na renda variável, em especial na bolsa de valores.

Esses novos investidores, são motivados principalmente pela possibilidade de maiores retornos que a renda variável oferece  aos seus investimentos. Porém, quanto maior a possibilidade de retorno, geralmente também, maior será o risco envolvido em um investimento. Por isso, cada vez mais os agentes financeiros tem procurado meios de melhorar suas análises, buscando os melhores ativos para seus clientes.

## Design do Experimento

Os dados de entrada do experimento são as informações de preços de fechamento dos últimos 36 meses de 5 ações diferentes.
O que se deseja é comparar o potencial de cada ação em gerar maior ganho mensal ao investidor. Como modelos regressivos de previsão não são o escopo deste trabalho, pode-se realizar uma transformação nestes dados, de forma que haja um vetor com as flutuações percentuais das ações em cada mês. Por exemplo, se houver uma ação com preços de fechamento $[10, 11, 12, 10]$, pode-se gerar o seguinte vetor de flutuações percentuais: $[10\%, 9\%, -16\%]$.
Desta forma, é possivel realizar uma análise estatística entre as 5 ações e identificar a que apresenta maior incidência de flutuação positiva.
Para este estudo, tem-se a seguinte escolha:

Nível de significância ($\alpha$) de 0,05. O nível de significância é a probabilidade de ocorrência de um falso positivo em qualquer procedimento de teste de hipótese \cite{NotasdeAula}.

\newpage
## Análise Estatística


### Importação dos dados

Os dados das ações foram importados do arquivo *DadosAcoesGrupoC.csv*.  

```{r, include=TRUE, echo=TRUE}

# importação dos dados
data <- read.csv(file = 'DadosAcoesGrupoC.csv', header = FALSE)
colnames(data) <- c("A1","A2","A3","A4","A5") # Adicionando nomes às colunas

# plot dos primeiros 6 dados da tabela
head(data)
```

Cada coluna representa uma ação e cada linha representa o preço de fechamento das ações no mês anterior. Portanto, a linha 1 indica o preço de fechamento do mês atual - 1, a linha 2 representa o mês atual - 2, e assim sucessivamente. Desta forma, foi plotado os gráficos abaixo, nos quais o eixo x, que representa os meses, inicia do mês mais antigo e progride para o mais recente, sendo x igual a zero o mês atual. 

```{r, include=TRUE, echo=TRUE}
theme_set(theme_minimal())
#numerando o eixo x do valor mais antigo (mesatual - 36) 
#ao mês anterior (mesatual - 1)
numeracao <- -1:-36 

# Plot
plot_a1 <- ggplot(data=data, aes(x=numeracao, y=A1)) + geom_line() + 
  labs(title = "Ação 1", x = "Tempo (meses)", y = "$ fechamento") + ylim(10, 35)
plot_a2 <- ggplot(data=data, aes(x=numeracao, y=A2)) + geom_line() + 
  labs(title = "Ação 2", x = "Tempo (meses)", y = "$ fechamento") + ylim(10, 35)
plot_a3 <- ggplot(data=data, aes(x=numeracao, y=A3)) + geom_line() + 
  labs(title = "Ação 3", x = "Tempo (meses)", y = "$ fechamento") + ylim(10, 35)
plot_a4 <- ggplot(data=data, aes(x=numeracao, y=A4)) + geom_line() + 
  labs(title = "Ação 4", x = "Tempo (meses)", y = "$ fechamento") + ylim(10, 35)
plot_a5 <- ggplot(data=data, aes(x=numeracao, y=A5)) + geom_line() + 
  labs(title = "Ação 5", x = "Tempo (meses)", y = "$ fechamento") + ylim(10, 35)

grid.arrange(plot_a1, plot_a2, plot_a3, plot_a4, plot_a5, nrow = 3)
```

### Tratamento  dos dados

Os dados brutos serão transformados em flutuações percentuais para que se possa realizar a análise estatística.

```{r, include=TRUE, echo=TRUE}

# Transforma dados em porcentagens
data_perc <- data
for(i in (nrow(data)-1):1){
        data_perc[i,] <- 100*( (data[i,] - data[i+1,])/data[i+1,] ) 
# porcentagem de mudança do fechamento do mes i + 1 em relação ao mes i.
}

# removendo ultima linha
data_perc <- data_perc[-c(36), ] 

# Criando uma variável para cada amostra
data_a1 <- data_perc$A1
data_a2 <- data_perc$A2
data_a3 <- data_perc$A3
data_a4 <- data_perc$A4
data_a5 <- data_perc$A5
head(data_perc)
```

Em posse das flutuações percentuais, foi plotado o seguinte boxplot para uma análise visual das variações destes valores para cada uma das ações.

```{r, include=TRUE}

# boxplot
boxplot(data_a1, data_a2, data_a3, data_a4, data_a5,
main = "Boxplots das flutuações percentuais",
at = c(1,2,3,4,5),
names = c("Ação 1", "Ação 2", "Ação 3", "Ação 4", "Ação 5"),
las = 2,
horizontal = TRUE,
notch = FALSE
)
```

Em uma análise visual, é possível perceber que as ações 1 e 5 possuem os maiores valores de variações positivos de um mês para outro nestes 36 meses, enquanto a ação 2 possui a maior variação negativa nesta mesma situação. No entanto, estas inferências não são suficientes visto que, hipoteticamente, uma ação pode ter uma subida abrupta em um determinado momento e uma sequência considerável de quedas de forma a atingir valores menores do que o valor inicial dessa suposição. Da mesma forma, esta mesma ação pode ter uma queda abrupta em um determinado momento e uma sequência considerável de subidas de forma a atingir valores maiores do que o valor inicial dessa suposição.
Assim, percebe-se a importância de uma análise estatística dos dados históricos no período em comparação para uma tomada de decisão mais pertinente, visto que a média do comportamento de uma ação carrega um valor estatístico maior do que uma análise isolada de algum mês específico, por exemplo.


### Dados estatísticos

Para a análise destas ações, foi escolhido o teste da Análise de Variância (ANOVA) capaz de determinar se as médias de três ou mais grupos são diferentes. A ANOVA usa testes F para testar estatisticamente a igualdade entre médias \cite{anova}.


#### Premissas do teste:

Para a realização do teste ANOVA, é necessário que as seguintes premissas sejam cumpridas \cite{anova_premissas}: 

•	As amostras devem ser independentes;

•	As amostras devem apresentar distribuição normal;

•	As variâncias podem ser consideradas iguais (homocedasticidade).

**Verificação da independência**: Como não há maiores informações sobre o ramo de atuação das empresas e suas origens, assumiu-se que elas não possuem nenhum fator que cause interferência entre elas. Portanto, serão consideradas independentes.

**Verificação de Normalidade**: Para uma avaliação estatística sobre a validação da hipótese de uma distribuição normal para as amostras, pode-se usar o teste Shapiro-Wilk, onde têm-se as seguintes hipóteses \cite{teste_norm_R}:

$$\begin{cases} H_0: \text{A amostra provém de uma população com distribuição normal}\\H_1: \text{A amostra não provém de uma população com distribuição normal} \end{cases}$$
```{r, include=TRUE}
apply(data_perc, 2, shapiro.test)
```
Como interpretação do teste, tem-se que se o p-valor < 0.05 ($\alpha$), deve-se rejeitar a hipótese nula, ou seja, os dados não possuem distribuição normal \cite{teste_norm_R}, caso contrário, não há evidências para se rejeitar a hipótese nula. Portanto, analisando os resultados dos testes dispostos acima, pode-se considerar que as amostras de todas as flutuações percentuais das ações seguem distribuição normal.

**Verificação de homocedasticidade**: Para a verificação de homocedasticidade entre dois ou mais grupos de amostras, pode-se utilizar o teste de Levene ou Bartlett, onde têm-se as seguintes hipóteses \cite{bartlett}:

$$\begin{cases} H_0: \text{As variâncias dos erros são homogêneas}\\H_1: \text{As variâncias dos erros não são homogêneas} \end{cases}$$
O teste de Bartlett é sensível em relação a hipótese de normalidade dos dados. Se a hipótese da normalidade tivesse sido rejeitada, seria melhor utilizar o teste proposto por Levene. Porém, como a hipótese da normalidade não foi rejeitada, o teste proposto por Bartlett tem um comportamento melhor que o teste proposto por Levene \cite{bartlett}. Com o objetivo de agregar mais valor ao estudo, ambos foram efetuados:

```{r, include=TRUE}

# teste de Bartlett
y <- c(data_a1, data_a2, data_a3, data_a4, data_a5)
group <- as.factor(c(rep(1, length(data_a1)), rep(2, length(data_a2)), 
                     rep(3, length(data_a3)), rep(4, length(data_a4)), rep(5, length(data_a5))))
bartlett.test(y, group)
```

```{r, include=TRUE}
# teste de Levene
leveneTest(y, group)
```

Como interpretação do teste, tem-se que se o p-valor < 0.05 ($\alpha$), deve-se rejeitar a hipótese nula, ou seja, as variâncias dos grupos de amostras não são homogêneas, caso contrário, não há evidências para se rejeitar a hipótese nula. Portanto, analisando os resultados dos testes dispostos acima, onde o p-valor é maior que 0.05, pode-se considerar que as variâncias são homogêneas.

Dada a independência considerada entre os valores, a análise e confirmação da normalidade e homocedasticidade dos dados, pode-se aplicar o teste ANOVA, onde têm-se as seguintes hipóteses:

$$\begin{cases} H_0: \text{A média de todas as populações são iguais}\\H_1: \text{A média de pelo menos uma população é diferente} \end{cases}$$
```{r, include=TRUE}
# teste ANOVA
anova <- aov(y~group)
anova
summary(anova)
```

Como interpretação do teste, temos que se o p-valor < 0.05 ($\alpha$), deve-se rejeitar a hipótese nula, ou seja, as médias dos grupos de amostras não são homogêneas, caso contrário, não há evidências para se rejeitar a hipótese nula. Portanto, analisando os resultados dos testes dispostos acima, podemos considerar que as médias dos grupos não são iguais. Ou seja, pelo menos uma das amostras tem sua média diferente. Desta forma, é possível concluir que, estatisticamente, haverá diferença em pelo menos uma ação dentre as cinco possíveis para investimento.
Essa conclusão, embora importante, não é suficiente, pois ainda não se sabe quantas ações possuem médias diferentes e se são superiores ou inferiores às demais.

Portanto, para dar sequência aos estudos, optou-se por fazer uma análise por pares, para que seja feita uma varredura entre todas as ações em busca daquelas onde a diferença entre as médias fosse significativa, as chamadas comparações múltiplas. Neste contexto, será aplicado o Teste de Tukey. Este teste foi escolhido, pois quando os tamanhos amostrais dos grupos são iguais, o Teste de Tukey é um teste exato, ou seja, para o conjunto de todas as comparações par a par, a taxa de erro do conjunto dos testes é exatamente $\alpha$ (nível de significância) e o intervalo de confiança é exatamente 1 – $\alpha$. Vale ressaltar que testes de comparações múltiplas exatos são raros, uma vez que a maioria não controla o nível de significância adotado \cite{tukey}.

Para realizar o Teste de Tukey, deve ser levada em conta as seguintes suposições \cite{teste_norm_R}:

•	As observações são independentes dentro e entre os grupos;

•	Os grupos devem ser normalmente distribuídos;

•	A variância dentro do grupo deve ser constante.

Como não houve alteração nas amostras, pode-se concluir que todas as premissas foram atendidas e, portanto, o teste pode ser efetuado.

```{r, include=TRUE}

# teste Tukey
library(agricolae)
data3 = data.frame(y,group) 
model2 <- aov(y~group, data = data3)
tukey = TukeyHSD(x=model2, "group")
tukey
```

Para facilitar a análise, o seguinte gráfico foi plotado.

```{r, include=TRUE}
#plot teste Tukey
plot(tukey, las=1, col="brown")
```

Pela análise do teste de Tukey, pode-se fazer algumas observações:

•	A ação 1 possui média maior que as ações 2, 3 e 4 e média estatisticamente semelhante a ação 5;

•	A ação 2 possui média estatisticamente igual às ações 3 e 4;

•	A ação 5 possui média maior que as ações 2, 3 e 4 e média estatisticamente semelhante a ação 1;

Portanto, pode-se concluir que, estatisticamente, as ações 1 e 5 possuem médias semelhantes entre si e maiores do que as outras três ações.

Com isso, percebe-se que, através de testes estatísticos, as ações 1 e 5 seriam boas escolhas para o investidor. No entanto, a proposta é que seja escolhida apenas uma e, portanto, outro parâmetro de análise deve ser utilizado para a tomada de decisão entre as duas ações em questão. 

Para escolher entre as duas ações foi levado em consideração a tendência baseada no valor de fechamento mensal histórico de cada uma delas. O gráfico abaixo apresenta os valores de fechamento (pontos) de cada uma das duas ações em análise e a linha de tendência (linha azul) de cada uma.

```{r, include=TRUE, echo=TRUE}

#Plot

plot_a1 <- ggplot(data=data, aes(x=numeracao, y=A1)) + geom_point() + geom_smooth() +
  labs(title = "Ação 1", x = "Tempo (meses)", y = "$ fechamento") + ylim(10, 35)

plot_a5 <- ggplot(data=data, aes(x=numeracao, y=A5)) + geom_point() + geom_smooth() +
  labs(title = "Ação 5", x = "Tempo (meses)", y = "$ fechamento") + ylim(10, 35)

grid.arrange(plot_a1, plot_a5, nrow = 1)

```


Com base na observação dos gráficos, infere-se que ambas ações apresentam uma tendência de alta. Porém, a inclinação da linha de tendência da ação 5 é maior quando comparada à ação 1. Isto sugere que, historicamente, a ação 5 apresentou maiores altas nos seus fechamentos quando comparada à ação 1. Assim, se o investidor busca a maior rentabilidade, esta seria a melhor escolha.

Porém, também é interessante que se faça a análise do risco apresentado por cada uma das duas ações. Para isso, será analisado qual das duas ações apresentou a maior queda ao longo dos 36 meses. Portanto, abaixo são mostrados os valores mínimos das flutuações mensais para as duas ações.

```{r, include=TRUE, echo=TRUE}

min_a1 = min(data_a1)
min_a5 = min(data_a5)
data_min1 <- 1:2
data_min1[1] <- min_a1
data_min1[2] <- min_a5

data_min <- matrix(data_min1,1,2)
colnames(data_min) <- c("A1","A5") # Adicionando nomes às colunas
rownames(data_min) <- c("Minimo")

head(data_min)


```

Através da análise dos mínimos, aplicada aos dados de flutuação percentual mensal de cada uma das ações, pode-se inferir que ao longo dos 36 meses a ação 1 apresentou a maior flutuação negativa. Portanto, ao comparar-se as duas, o investidor correrá um risco de maior queda caso opte pela ação 1. Desta maneira, do ponto de vista de risco, também é mais recomendável que o investimento seja realizado na ação 5.

## Discussão e Conclusão

O estudo teve como objetivo definir entre cinco ações previamente selecionadas, qual apresenta o maior potencial de ganho mensal para um investidor que deseja investir todo seu capital em uma única ação da bolsa de valores. Foram fornecidos os dados de fechamento dos preços mensais das cinco ações ao longo dos últimos 36 meses.

Para a análise ser realizada, os dados fornecidos foram analisados sob a ótica das flutuações percentuais das ações em cada mês, o que possibilitou por exemplo, determinar quais ações apresentam a maior média nas flutuações dos preços mensais.

Escolheu-se o teste ANOVA para determinar se havia diferença significativa entre a médias das flutuações das ações analisadas. Para utilização da ANOVA foi necessário verificar a independência entre as amostras, a normalidade na distribuição dos dados e, também, a homocedasticidade. Para verificar a independência, como não havia informações sobre as empresas, assumiu-se que elas não possuíam interferência entre si. Para verificação de normalidade, utilizou-se o teste Shapiro-Wilk e para verificação da homocedasticidade utilizou-se os testes de Bartlett e Levene, todos foram apresentados neste relatório.

Após a verificação dos requisitos, aplicou-se a ANOVA e através de seu resultado foi possível inferir que pelo menos uma das amostras possuía sua média diferente das outras. Porém, ainda não haviam dados suficientes para determinar o que foi solicitado. Escolheu-se então o Teste de Tukey para determinar quais ações entre as cinco analisadas, possuíam diferenças significativas entre suas médias.

Através do Teste de Turkey foi possível concluir que as ações 1 e 5 se destacavam das demais, do ponto de vista de rentabilidade, apresentando as melhores flutuações nos preços dos fechamentos mensais. A partir desta conclusão, a análise prosseguiu apenas para as ações 1 e 5. Para escolher a melhor entre as duas, analisou-se as tendências de cada uma delas e pôde-se perceber que, embora ambas apresentassem tendência de alta, a ação 5 apresentou a maior tendência de alta entre as duas e, portanto, do ponto de vista de rentabilidade ela foi a mais recomendada. Optou-se ainda por realizar uma última análise, levando em consideração o risco envolvido em cada uma das opções, para isso analisou-se os valores mínimos das flutuações nos preços de fechamento mensal das duas ações e observou-se que a ação 1 apresentou a maior queda percentual ao longo dos 36 meses. Portanto, considerando o risco, a ação 5 também foi a mais recomendada.

Desta forma, concluiu-se que para os dados fornecidos e através das análises realizadas e apresentadas, a ação 5 é a mais recomendada para o investidor que deseja investir todo seu capital em uma única ação da bolsa.


### Atividades dos membros

**Diego**

Elaboração dos testes e construção textual.

**Elias**

Elaboração textual, análise dos resultados e tomada de decisão.

**Matheus**

Elaboração do experimento e estruturação dos códigos.

**Todos**

Elaboração das hipóteses e definição das premissas.


\renewcommand\refname{Referências Bibliográficas}
\bibliographystyle{unsrt}
\bibliography{referencias}
